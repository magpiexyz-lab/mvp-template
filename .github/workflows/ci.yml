name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Cancel in-progress runs for the same PR when a new commit is pushed
concurrency:
  group: ci-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck
        run: |
          for script in scripts/consistency-check.sh; do
            if [ -f "$script" ]; then
              shellcheck "$script"
            else
              echo "$script not found — skipping"
            fi
          done

      - name: Install PyYAML
        run: pip3 install pyyaml

      - name: Validate frontmatter
        run: python3 scripts/validate-frontmatter.py

      - name: Validate semantics
        run: python3 scripts/validate-semantics.py

      - name: Validate YAML files
        run: |
          python3 -c "
          import yaml, sys
          errors = []
          for f in ['idea/idea.yaml', 'EVENTS.yaml']:
              try:
                  with open(f) as fh:
                      yaml.safe_load(fh)
                  print(f'{f}: OK')
              except FileNotFoundError:
                  print(f'{f}: not found (OK for template)')
              except yaml.YAMLError as e:
                  errors.append(f'{f}: {e}')
                  print(f'{f}: INVALID')
          # Validate EVENTS.yaml structure
          try:
              with open('EVENTS.yaml') as fh:
                  data = yaml.safe_load(fh)
              if data:
                  for key in ['standard_funnel', 'custom_events']:
                      if key not in data:
                          errors.append(f'EVENTS.yaml: missing required key \"{key}\"')
                  for section in ['standard_funnel', 'payment_funnel']:
                      if section in data:
                          for i, ev in enumerate(data[section]):
                              if 'event' not in ev:
                                  errors.append(f'EVENTS.yaml: {section}[{i}] missing \"event\" field')
                              if 'trigger' not in ev:
                                  errors.append(f'EVENTS.yaml: {section}[{i}] missing \"trigger\" field')
          except FileNotFoundError:
              pass
          if errors:
              for e in errors:
                  print(f'ERROR: {e}', file=sys.stderr)
              sys.exit(1)
          "

      - name: Consistency check
        run: |
          if [ -f scripts/consistency-check.sh ]; then
            bash scripts/consistency-check.sh
          else
            echo "No consistency-check.sh found — skipping"
          fi

  build:
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Dummy env vars so `npm run build` can compile without real credentials.
    # The app handles missing values gracefully at runtime.
    # These match the default stack (supabase + posthog). If you change
    # stack.database or stack.analytics in idea.yaml, update these env var
    # names to match the new stack's environment variables.
    # After bootstrap, compare .env.example with these CI placeholders and
    # add any new variables here so CI builds don't break.
    # If you add a stack with new env vars, add placeholders here too.
    env:
      NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
      NEXT_PUBLIC_POSTHOG_KEY: phc_placeholder
      NEXT_PUBLIC_POSTHOG_HOST: https://us.i.posthog.com
      # Payment stack (stack.payment: stripe) — safe to leave even without payments
      STRIPE_SECRET_KEY: placeholder-stripe-secret
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: placeholder-stripe-publishable
      STRIPE_WEBHOOK_SECRET: placeholder-stripe-webhook-secret
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm
        # cache: npm requires package-lock.json. If it doesn't exist yet
        # (e.g., bootstrap PR), setup-node skips caching gracefully.

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "No package.json found — skipping install"
          fi

      - name: Build
        run: |
          if [ -f package.json ]; then
            npm run build
          else
            echo "No package.json found — skipping build"
          fi

      - name: Lint
        run: |
          if [ -f package.json ] && node -e "process.exit(require('./package.json').scripts?.lint ? 0 : 1)" 2>/dev/null; then
            npm run lint
          else
            echo "No lint script found — skipping"
          fi

  e2e:
    needs: build
    if: hashFiles('playwright.config.ts') != ''
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NEXT_PUBLIC_POSTHOG_KEY: phc_placeholder
      NEXT_PUBLIC_POSTHOG_HOST: https://us.i.posthog.com
      # Payment stack (stack.payment: stripe)
      STRIPE_SECRET_KEY: ${{ secrets.E2E_STRIPE_SECRET_KEY }}
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.E2E_STRIPE_PUBLISHABLE_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.E2E_STRIPE_WEBHOOK_SECRET }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm
      - uses: supabase/setup-cli@v1
      - name: Start local Supabase
        run: supabase start -x realtime,storage,imgproxy,inbucket,pgadmin-schema-diff,migra,postgres-meta,studio,edge-runtime,logflare,pgbouncer,vector
      - name: Apply migrations
        run: supabase db reset
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Run E2E tests
        run: npx playwright test
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
      - name: Stop local Supabase
        if: ${{ always() }}
        run: supabase stop

  preview-smoke:
    needs: build
    if: github.event_name == 'pull_request' && hashFiles('playwright.config.ts') != ''
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      NEXT_PUBLIC_POSTHOG_KEY: phc_placeholder
      NEXT_PUBLIC_POSTHOG_HOST: https://us.i.posthog.com
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm
      - name: Wait for Vercel preview
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.2
        id: preview
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Smoke test preview deployment
        run: npx playwright test e2e/smoke.spec.ts --global-setup="" --global-teardown=""
        env:
          E2E_BASE_URL: ${{ steps.preview.outputs.url }}
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: preview-smoke-report
          path: playwright-report/
          retention-days: 7

  secret-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
