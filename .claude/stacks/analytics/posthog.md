---
assumes: [framework/nextjs]
packages:
  runtime: [posthog-js, posthog-node]
  dev: []
files:
  - src/lib/analytics.ts
  - src/lib/analytics-server.ts
  - src/lib/events.ts
env:
  server: []
  client: [NEXT_PUBLIC_POSTHOG_KEY, NEXT_PUBLIC_POSTHOG_HOST]
ci_placeholders:
  NEXT_PUBLIC_POSTHOG_KEY: phc_placeholder
  NEXT_PUBLIC_POSTHOG_HOST: "https://us.i.posthog.com"
clean:
  files: []
  dirs: []
gitignore: []
---
# Analytics: PostHog
> Used when idea.yaml has `stack.analytics: posthog`

## Packages
```bash
npm install posthog-js posthog-node
```

## Files to Create

### `src/lib/analytics.ts`
```ts
import posthog from "posthog-js";

const PROJECT_NAME = "TODO"; // Replaced by bootstrap with idea.yaml `name`
const PROJECT_OWNER = "TODO"; // Replaced by bootstrap with idea.yaml `owner`

let initialized = false;

function init() {
  if (initialized || typeof window === "undefined") return;
  posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
    api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST,
    capture_pageview: false,
  });
  initialized = true;
}

export function track(event: string, properties?: Record<string, unknown>) {
  init();
  posthog.capture(event, {
    ...properties,
    project_name: PROJECT_NAME,
    project_owner: PROJECT_OWNER,
  });
}

export function identify(userId: string, traits?: Record<string, unknown>) {
  init();
  posthog.identify(userId, traits);
}

export function reset() {
  init();
  posthog.reset();
}
```

Notes:
- `init()` is lazy — safe to import server-side, PostHog only initializes on first client-side call
- `capture_pageview: false` because pages fire explicit events via `events.ts`
- Bootstrap replaces `PROJECT_NAME` and `PROJECT_OWNER` with actual idea.yaml values
- Global properties are placed after the spread so they can't be overridden by callers

### `src/lib/analytics-server.ts` — Server-side tracking (for webhooks and API routes)
```ts
import { PostHog } from "posthog-node";

const PROJECT_NAME = "TODO"; // Replaced by bootstrap with idea.yaml `name`
const PROJECT_OWNER = "TODO"; // Replaced by bootstrap with idea.yaml `owner`

export async function trackServerEvent(
  event: string,
  distinctId: string,
  properties?: Record<string, unknown>
) {
  const client = new PostHog(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
    host: process.env.NEXT_PUBLIC_POSTHOG_HOST,
  });

  client.capture({
    distinctId,
    event,
    properties: {
      ...properties,
      project_name: PROJECT_NAME,
      project_owner: PROJECT_OWNER,
    },
  });

  await client.shutdown();
}
```

Notes:
- Creates a PostHog client per call and calls `shutdown()` to flush — required for serverless (Vercel)
- Uses the same `NEXT_PUBLIC_POSTHOG_KEY` and `NEXT_PUBLIC_POSTHOG_HOST` env vars as client-side (available on server in Next.js)
- Auto-attaches `project_name` and `project_owner` like client-side `track()`
- Bootstrap replaces `PROJECT_NAME` and `PROJECT_OWNER` with actual idea.yaml values
- Use this in webhook handlers and API routes for server-side events (e.g., `pay_success`)

### `src/lib/events.ts` — Typed event wrappers (generated by bootstrap from EVENTS.yaml)
```ts
import { track } from "./analytics";

// --- Standard funnel events (always generated) ---

export function trackVisitLanding(props?: { referrer?: string; utm_source?: string }) {
  track("visit_landing", props);
}

export function trackSignupStart(props: { method: string }) {
  track("signup_start", props);
}

export function trackSignupComplete(props: { method: string }) {
  track("signup_complete", props);
}

export function trackActivate(props: { action: string }) {
  track("activate", props);
}

export function trackRetainReturn(props: { days_since_last: number }) {
  track("retain_return", props);
}

// --- Payment funnel events (only when stack.payment is present in idea.yaml) ---

export function trackPayStart(props: { plan: string; amount_cents: number }) {
  track("pay_start", props);
}

export function trackPaySuccess(props: { plan: string; amount_cents: number; provider: string }) {
  track("pay_success", props);
}
```

Notes:
- Bootstrap generates this file from EVENTS.yaml — the template above matches the default EVENTS.yaml. If custom events are added to EVENTS.yaml later, they use `track()` from `analytics.ts` directly (no typed wrapper needed).
- `trackVisitLanding` uses an optional props parameter since all its properties are optional in EVENTS.yaml.
- Payment funnel functions (`trackPayStart`, `trackPaySuccess`) are only included when `stack.payment` is present in idea.yaml. Omit them otherwise.
- `trackPaySuccess` is exported for completeness but the webhook handler uses `trackServerEvent()` from `analytics-server.ts` instead (server-side). The client-side wrapper is available if a success page needs to track it.
- Pages import from `@/lib/events` instead of calling `track()` directly — this provides compile-time validation of event names and property types.

## Environment Variables
```
NEXT_PUBLIC_POSTHOG_KEY=phc_your-posthog-key
NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com
```

## Patterns
- Client-side tracking goes through `src/lib/analytics.ts` — never import posthog-js directly in pages or components
- Server-side tracking (webhooks, API routes) goes through `src/lib/analytics-server.ts` — never import posthog-node directly in route handlers
- `track()` auto-attaches `project_name` and `project_owner` to every event
- All projects in the company share the same analytics project — these properties distinguish experiments
- If you rename the project in idea.yaml (`name` field), update the `PROJECT_NAME` and `PROJECT_OWNER` constants in both `src/lib/analytics.ts` and `src/lib/analytics-server.ts`

## Test Blocking
When running E2E tests, block analytics requests to prevent test data from polluting production analytics. The endpoint pattern for PostHog is:
```
**/posthog*/**
```
This matches the PostHog ingestion endpoint (e.g., `https://us.i.posthog.com`). Playwright's `page.route()` uses this pattern to intercept and abort analytics requests. See the testing stack file's `blockAnalytics` helper for usage.

When creating a new analytics stack file, document the equivalent endpoint pattern so the testing stack file can adapt its route blocking.

## Audit Checklist (for /change skill — analytics type)
- Verify `track()` in `analytics.ts` and `trackServerEvent()` in `analytics-server.ts` both exist and auto-attach `project_name` and `project_owner`
- Verify `project_name` and `project_owner` values match idea.yaml in both files
- If any values are wrong, fix both analytics files before auditing pages/routes

## PR Instructions
- After merging, ensure `NEXT_PUBLIC_POSTHOG_KEY` and `NEXT_PUBLIC_POSTHOG_HOST` are set in your hosting provider's environment variables
- Verify events are flowing: open the app, perform an action, then check PostHog → Activity → Live Events

## Dashboard Navigation (for /iterate skill)
How to pull funnel numbers from PostHog:
1. Go to your PostHog dashboard -> **Insights** -> **New insight** -> **Funnel**
2. Add these events in order: `visit_landing` -> `signup_start` -> `signup_complete` -> `activate` -> `pay_start` -> `pay_success`. If `stack.payment` is absent from idea.yaml, omit `pay_start` and `pay_success` from the funnel.
3. Add a filter: `project_name` equals your idea.yaml `name` value
4. Set the date range to match your experiment's start date
5. Read the count at each funnel stage
